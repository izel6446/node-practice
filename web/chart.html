<!doctype html>
<head>
  <title>Chart</title>
  <meta charset="UTF-8"/>
  <script src="/script/chart.js/dist/Chart.bundle.min.js"></script>
  <noscript>
    현재 사용 중인 브라우저는 스크립트를 지원하지 않거나, 해당 기능이 활성화되어 있지 않습니다!
  </noscript>
  <script>

    function changeDataSelect(){
      var langSelect = document.getElementById("data");
      var selectValue = langSelect.options[langSelect.selectedIndex].value;
      var selectText = langSelect.options[langSelect.selectedIndex].text;

      var url = `/chart/stat/${selectValue}`;

      callAjax("GET", `${url}?dataonly`, function(data){
        drawGraph('myChart', JSON.parse(data), {});
        history.pushState(null, null, url);
      })

    }
    function callAjax(method, url, callback){
        var xmlhttp;
        // compatible with IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function(){
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
                callback(xmlhttp.responseText);
            }
        }
        xmlhttp.open(method, url, true);
        xmlhttp.send();
    }
    </script>
    <script>
      class ColorUtil {
    color_array = [];
    constructor(data){
      for(let i=0;i<data.length;i++){
        const r = Math.floor(Math.random() * 255);
        const g = Math.floor(Math.random() * 255);
        const b = Math.floor(Math.random() * 255);
        this.color_array.push(`rgba(${r}, ${g}, ${b}, $OPACITY)`);
      }
    }

    randomColorWithOpacity(opacity){
      const rtn = this.color_array.map(x => x.replace("$OPACITY",opacity));
      return rtn;
    }

    static category10(opacity){
      return [
        `rgba( 31, 119, 180, ${opacity})`,
        `rgba(255, 127,  14, ${opacity})`,
        `rgba( 44, 160,  44, ${opacity})`,
        `rgba(214,  39,  40, ${opacity})`,
        `rgba(148, 103, 219, ${opacity})`,
        `rgba(140,  86,  75, ${opacity})`,
        `rgba(227, 119, 194, ${opacity})`,
        `rgba(127, 127, 127, ${opacity})`,
        `rgba(188, 189,  34, ${opacity})`,
        `rgba( 23, 190, 207, ${opacity})`
      ]
    }
  
    static tableau10(opacity) {
      return [
        `rgba( 78, 121, 167, ${opacity})`,
        `rgba(242, 142,  44, ${opacity})`,
        `rgba(225,  87,  89, ${opacity})`,
        `rgba(118, 183, 178, ${opacity})`,
        `rgba( 89, 161,  79, ${opacity})`,
        `rgba(237, 201,  73, ${opacity})`,
        `rgba(175, 122, 161, ${opacity})`,
        `rgba(255, 157, 167, ${opacity})`,
        `rgba(156, 101,  95, ${opacity})`,
        `rgba(186, 176, 171, ${opacity})`
      ]
    }
  }

  let currentChart = null;

  function drawGraph(id, data){
    if(currentChart != null){
      currentChart.destroy();
    }
    const val = data.map(function(item){
    return item.value;
    })
    const key = data.map(function(item){
      return item._id;
    })
    const color = new ColorUtil(data);
    const element = document.getElementById(id);
    var ctx = element.getContext('2d');
    ctx.clearRect(0, 0, element.width, element.height);
    ctx.beginPath();

    currentChart = new Chart(ctx, {
        type: option.type || 'bar' ,
        data: {
            labels: key,
            datasets: [{
                label: 'Value',
                data: val,
                backgroundColor: color.randomColorWithOpacity(0.3),
                borderColor: color.randomColorWithOpacity(0.8),
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
    });
  }

    </script>
</head>
<body>
  <div>
    <select id="data" title="data" onchange="changeDataSelect()">
      <optgroup value="클라이언트">
        <option value="client.geo">지역 코드</option>
        <option value="client.ip">IP</option>
      </optgroup>
      <optgroup title="에이전트">
        <option value="agent.os">OS</option>
        <option value="agent.platform">플랫폼</option>
        <option value="agent.browser">브라우저</option>
        <option value="agent.version">버전</option>
      </optgroup>
      <optgroup title="게시판">
        <option value="board">게시판</option>
      </optgroup>
      <optgroup title="사용자">
        <option value="user.userid">사용자 ID</option>
        <option value="user.age">연령</option>
        <option value="user.sex">성별</option>
        <option value="user.region">지역</option>
      </optgroup>
    </select>
  </div>
<div style="width:1200px;height:900px">
  <canvas id="myChart"></canvas>
  <script>
  
  const data = JSON.parse('<%-data%>');
  const option = JSON.parse('<%-option%>');
  

  drawGraph('myChart', data, option);

  
  </script>
</div>
</body>